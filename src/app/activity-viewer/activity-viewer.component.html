<p-toast key="activity"></p-toast>
<app-ui-command-editor #commandeditor (updateItem)="updateGridItem($event)"
  (addItem)="addGridItem($event)" (deleteItem)="deleteGridItem($event)"
  [remote]="remote" [activity]="activity" [gridItem]="gridItem" [gridCommands]="gridCommands" [grid]="currentPage?.grid"></app-ui-command-editor>
<p-toolbar *ngIf="!editMode">
<div class="flex align-content-left flex-wrap gap-3">
  <div class="flex align-items-center justify-content-center" *ngIf="!editMode && remote && activity?.icon">
    <span id="icon" class="icon-selected">
      <ng-container *ngIf="Helper.isStandardIcon(activity!.icon!)">
        <span [class]="Helper.getIconClass(activity!.icon!)"></span>
      </ng-container>
      <ng-container *ngIf="Helper.isCustomIcon(activity!.icon!)">
        <img [src]="Helper.getIconURL(remote!, activity!.icon!)" [alt]="activity!.icon!" width="70" height="70">
      </ng-container>
    </span>
  </div>
  <div class="flex align-items-center justify-content-center">
    <h3>Activity</h3>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button label="Edit" [routerLink]="['/activity/edit', activity?.entity_id]" severity="warning" icon="pi pi-pen-to-square" size="small"></p-button>&nbsp;&nbsp;
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button label="Copy to clipboard" (onClick)="copyToClipboard(activity, 'Activity '+activity?.name+' copied to clipboard')" icon="pi pi-copy" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button label="Clone" [routerLink]="['/activity/clone', activity?.entity_id]" severity="warning" icon="pi pi-clone" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button label="Save to file" (onClick)="saveActivity()" icon="pi pi-save" size="small" severity="success"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button label="Delete" (onClick)="deleteActivity($event)" icon="pi pi-trash" size="small" severity="danger"></p-button>
  </div>
</div>
</p-toolbar>
<p-toolbar styleClass="toolbar-included-entities"><h3>Included entities</h3>
  <p-chip *ngFor="let entity of activity?.options?.included_entities" [label]="Helper.getEntityName(entity)"
          [style]="getStyle(Helper.getEntityName(entity))" [pTooltip]="entity.entity_id"></p-chip>&nbsp;
</p-toolbar>
<h3>Buttons mapping and startup/stop sequences</h3>
<div class="flex justify-content-center flex-wrap gap-6">
  <div class="flex-grow-1 flex-column">
    <div class="flex align-items-start justify-content-center">
      <h3>Buttons mapping for {{getRemoteModel()?.name}}</h3>
    </div>
    <div class="flex align-items-start justify-content-center" *ngIf="getRemoteModel()?.model == 'UCR2'">
      <app-image-map image="assets/remote/remote-two.png" [imageSize]="{width: 400, height: 400}" (overElement)="buttonOver($event)"
                     (clickElement)="selectButton($event)" [selectedTags]="mappedButtons" [imageTemplate]="r2Areas">
        <ng-template #r2Areas>
          <area target="" alt="Volume +" title="Volume +" href="#" data-tag="volumeup" coords="5,87,83,163" shape="rect">
          <area target="" alt="Volume -" title="Volume -" href="#" data-tag="volumedown" coords="5,243,81,312" shape="rect">
          <area target="" alt="Mute" title="Mute" href="#" data-tag="mute" coords="5,321,76,390" shape="rect">
          <area target="" alt="Previous chapter" title="Previous chapter" href="#" data-tag="previous" coords="89,320,158,390" shape="rect">
          <area target="" alt="Play pause" title="Play pause" href="#" data-tag="playpause" coords="165,321,240,390" shape="rect">
          <area target="" alt="Next chapter" title="Next chapter" href="#" data-tag="next" coords="243,321,316,389" shape="rect">
          <area target="" alt="Back" title="Back" href="#" data-tag="back" coords="5,7,83,74" shape="rect">
          <area target="" alt="Power" title="Power" href="#" data-tag="power" coords="321,321,394,390" shape="rect">
          <area target="" alt="Home" title="Home" href="#" data-tag="home" coords="88,5,318,76" shape="rect">
          <area target="" alt="Mic" title="Mic" href="#" data-tag="mic" coords="325,1,398,76" shape="rect">
          <area target="" alt="Channel Up" title="Channel Up" href="#" data-tag="channelup" coords="325,85,394,161" shape="rect">
          <area target="" alt="Channel Down" title="Channel Down" href="#" data-tag="channeldown" coords="323,245,392,314" shape="rect">
          <area target="" alt="Cursor up" title="Cursor up" href="#" data-tag="cursorup" coords="163,87,241,149" shape="rect">
          <area target="" alt="Cursor down" title="Cursor down" href="#" data-tag="cursordown" coords="163,260,241,316" shape="rect">
          <area target="" alt="Cursor left" title="Cursor left" href="#" data-tag="cursorleft" coords="87,161,154,247" shape="rect">
          <area target="" alt="Cursor right" title="Cursor right" href="#" data-tag="cursorright" coords="247,154,316,247" shape="rect">
          <area target="" alt="Cursor enter" title="Cursor enter" href="#" data-tag="cursorenter" coords="161,158,241,245" shape="rect">
          <area target="" alt="Green" title="Green" href="#" data-tag="green" coords="87,90,156,152" shape="rect">
          <area target="" alt="Yellow" title="Yellow" href="#" data-tag="yellow" coords="249,90,314,147" shape="rect">
          <area target="" alt="Red" title="Red" href="#" data-tag="red" coords="89,254,158,312" shape="rect">
          <area target="" alt="Blue" title="Blue" href="#" data-tag="blue" coords="252,254,314,316" shape="rect">
        </ng-template>
      </app-image-map>
    </div>
    <div class="flex align-items-start justify-content-center"  *ngIf="getRemoteModel()?.model == 'UCR3'">
      <app-image-map image="assets/remote/remote-3.png" [imageSize]="{width: 400, height: 724}" (overElement)="buttonOver($event)"
                     (clickElement)="selectButton($event)" [selectedTags]="mappedButtons" [imageTemplate]="r3Areas">
        <ng-template #r3Areas>
          <area target="" alt="Slider" title="Slider" href="#" data-tag="slider" coords="4,1,391,81" shape="rect">
          <area target="" alt="Back" title="Back" href="#" data-tag="back" coords="6,85,98,154" shape="rect">
          <area target="" alt="Home" title="Home" href="#" data-tag="home" coords="106,86,292,151" shape="rect">
          <area target="" alt="Power" title="Power" href="#" data-tag="power" coords="299,87,392,153" shape="rect">
          <area target="" alt="Volume Up" title="Volume Up" data-tag="volumeup" href="#" coords="2,168,88,268" shape="rect">
          <area target="" alt="Volume Down" title="Volume Down" data-tag="volumedown" href="#" coords="1,465,97,561" shape="rect">
          <area target="" alt="Channel Up" title="Channel Up" href="#" data-tag="channelup" coords="310,168,392,273" shape="rect">
          <area target="" alt="Channel Down" title="Channel Down" href="#" data-tag="channeldown" coords="306,462,394,560" shape="rect">
          <area target="" alt="Cursor Up" title="Cursor Up" href="#" data-tag="cursorup" coords="154,217,249,306" shape="rect">
          <area target="" alt="Cursor Down" title="Cursor Down" href="#" data-tag="cursordown" coords="151,422,246,512" shape="rect">
          <area target="" alt="Cursor Left" title="Cursor Left" href="#" data-tag="cursorleft" coords="38,323,134,411" shape="rect">
          <area target="" alt="Cursor Right" title="Cursor Right" href="#" data-tag="cursorright" coords="269,323,361,415" shape="rect">
          <area target="" alt="Cursor Enter" title="Cursor Enter" href="#" data-tag="cursorenter" coords="144,311,256,413" shape="rect">
          <area target="" alt="Mute" title="Mute" href="#" data-tag="mute" coords="4,571,100,644" shape="rect">
          <area target="" alt="Record" title="Record" href="#" data-tag="record" coords="104,573,198,643" shape="rect">
          <area target="" alt="Context Menu" title="Context Menu" href="#" data-tag="contextmenu" coords="202,573,294,643" shape="rect">
          <area target="" alt="Mic" title="Mic" href="#" data-tag="mic" coords="299,571,393,643" shape="rect">
          <area target="" alt="Previous" title="Previous" href="#" data-tag="previous" coords="5,648,100,717" shape="rect">
          <area target="" alt="Next" title="Next" href="#" data-tag="next" coords="297,647,392,717" shape="rect">
          <area target="" alt="Stop" title="Stop" href="#" data-tag="stop" coords="104,648,196,717" shape="rect">
          <area target="" alt="Play Pause" title="Play Pause" href="#" data-tag="playpause" coords="201,649,292,717" shape="rect">
        </ng-template>
      </app-image-map>
    </div>
  </div>
  <div class="flex align-items-start justify-content-center" style="width: 400px">
    <div class="flex-grow-1 flex-column column-gap-3">
      <div class="flex align-items-start justify-content-center">
        <h3>{{mouseOverButtonName!}}</h3>
      </div>
    <ng-container *ngIf="mouseoverButton && mouseoverButton.short_press">
      <div class="flex align-items-start gap-1">
        <p-tag severity="success" value="Short press"/>
        <p-chip [label]="getEntityName(mouseoverButton.short_press.entity_id)"
                [style]="getStyle(getEntityName(mouseoverButton.short_press.entity_id))"
                [pTooltip]="mouseoverButton.short_press.entity_id"></p-chip>&nbsp;
        <p-chip [label]="getCommandName(mouseoverButton.short_press)" styleClass="chip-command"
                [style]="getStyle(mouseoverButton.short_press.cmd_id)"
                [pTooltip]="mouseoverButton.short_press.cmd_id"></p-chip>
      <ng-container *ngIf="mouseoverButton.short_press.params">
        <ng-container *ngFor="let param of getParams(mouseoverButton.short_press)">
          <ng-container *ngIf="getParam(mouseoverButton.short_press, param)">
            {{Helper.getEntityName(getParam(mouseoverButton.short_press, param))}} :
            {{getParamValue(mouseoverButton.short_press, param)}}
          </ng-container>
        </ng-container>
      </ng-container>
      </div>
    </ng-container>
    <ng-container *ngIf="mouseoverButton && mouseoverButton.long_press">
      <div class="flex align-items-start gap-1">
        <p-tag severity="warning" value="Long press"/>
        <p-chip [label]="getEntityName(mouseoverButton.long_press.entity_id)"
                [style]="getStyle(getEntityName(mouseoverButton.long_press.entity_id))"
                [pTooltip]="mouseoverButton.long_press.entity_id"></p-chip>&nbsp;
        <p-chip [label]="getCommandName(mouseoverButton.long_press)" styleClass="chip-command"
                [style]="getStyle(mouseoverButton.long_press.cmd_id)"
                [pTooltip]="mouseoverButton.long_press.cmd_id"></p-chip>
        {{mouseoverButton.long_press.cmd_id}}
        <ng-container *ngIf="mouseoverButton.long_press.params">
          <ng-container *ngFor="let param of getParams(mouseoverButton.long_press)">
            <ng-container *ngIf="getParam(mouseoverButton.long_press, param)">
              {{Helper.getEntityName(getParam(mouseoverButton.long_press, param))}} :
              {{getParamValue(mouseoverButton.long_press, param)}}
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
    </ng-container>
    <ng-container *ngIf="mouseoverButton && mouseoverButton.double_press">
      <div class="flex align-items-start gap-1">
        <p-tag severity="danger" value="Double press"/>
        <p-chip [label]="getEntityName(mouseoverButton.double_press.entity_id)"
                [style]="getStyle(getEntityName(mouseoverButton.double_press.entity_id))"
                [pTooltip]="mouseoverButton.double_press.entity_id"></p-chip>&nbsp;
        <p-chip [label]="getCommandName(mouseoverButton.double_press)" styleClass="chip-command"
                [style]="getStyle(mouseoverButton.double_press.cmd_id)"
                [pTooltip]="mouseoverButton.double_press.cmd_id"></p-chip>
        <ng-container *ngIf="mouseoverButton.double_press.params">
          <ng-container *ngFor="let param of getParams(mouseoverButton.double_press)">
            <ng-container *ngIf="getParam(mouseoverButton.double_press, param)">
              {{Helper.getEntityName(getParam(mouseoverButton.double_press, param))}} :
              {{getParamValue(mouseoverButton.double_press, param)}}
            </ng-container>
          </ng-container>
        </ng-container>
      </div>
    </ng-container>
    </div>
  </div>
  <div class="flex align-items-start justify-content-center">
    <app-activity-sequence [remote]="remote" [activity]="activity" [editable]="editMode" sequenceName="on" (onUpdate)="onChange.emit()"></app-activity-sequence>
  </div>
  <div class="flex align-items-start justify-content-center">
    <app-activity-sequence [remote]="remote" [activity]="activity" [editable]="editMode" sequenceName="off" (onUpdate)="onChange.emit()"></app-activity-sequence>
  </div>
</div><br>
<p-toolbar>
<div class="flex align-content-left flex-wrap gap-3">
  <div class="flex align-items-center justify-content-center">
    <h3>Page "{{currentPage?.name}}"</h3>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button label="Save to file" (onClick)="savePage()" icon="pi pi-save" size="small" severity="success"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center" *ngIf="currentPage">
    <p-button label="Copy page to clipboard" (onClick)="copyToClipboard(currentPage, 'Page '+currentPage.name+' copied to clipboard')" icon="pi pi-copy" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center" *ngIf="editMode">
    <p-button label="Paste from clipboard" (onClick)="pastePage()" severity="warning" icon="pi pi-clipboard" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center" *ngIf="editMode">
    <p-button label="Import from file" (onClick)="importPage()" severity="warning" icon="pi pi-file-import" size="small">
      <input #input_file_page type="file" style="display:none" (change)="loadInputFilePage($event)">
    </p-button>
  </div>
  <div class="flex align-items-center justify-content-center" *ngIf="editMode">
    <p-button label="Delete current page" (onClick)="deletePage($event)" severity="danger" icon="pi pi-trash" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button *ngIf="!selectionMode" severity="secondary" label="Selection mode" (onClick)="toggleSelectionMode()" icon="pi pi-pen-to-square" size="small"></p-button>
    <p-button *ngIf="selectionMode" severity="secondary" label="Normal mode" (onClick)="toggleSelectionMode()" icon="pi pi-pen-to-square" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center" *ngIf="selection.length > 0">
    <p-button [label]="'Copy '+selection.length+' commands'" (onClick)="copySelectionToClipboard()" icon="pi pi-copy" size="small"></p-button>
  </div>
  <div class="flex align-items-center justify-content-center">
    <p-button [label]="'Paste commands'" (onClick)="pasteSelectionFomClipboard()" icon="pi pi-clipboard" size="small"></p-button>
  </div>
</div>
</p-toolbar>
<div class="flex align-content-left flex-wrap gap-3">
  <ng-container *ngIf="currentPage">
  <br>
    <div class="flex-grow-1 flex-column">
      <div class="flex align-items-center justify-content-center">
        <div class="flex-none" *ngIf="editMode">
          <div class="flex-column">
            <div class="flex align-items-center justify-content-center">
              <b>Page name</b>
            </div>
            <input type="text" pInputText [(ngModel)]="currentPage.name" placeholder="Page name" style="min-width: 150px"/>
          </div>
        </div>
        <div class="flex-grow-1">
          <p-paginator (onPageChange)="onPageChange($event)" [first]="firstPage" [rows]="1" [totalRecords]="activity?.options?.user_interface?.pages?.length"></p-paginator>
        </div>
        <div class="flex-none" *ngIf="editMode">
          <div class="flex-column">
            <div class="flex align-items-center justify-content-center">
              Grid size
            </div>
            <div class="flex align-items-center">
              <p-inputNumber [(ngModel)]="currentPage.grid.width" [showButtons]="true" buttonLayout="horizontal" spinnerMode="horizontal" [step]="1" pTooltip="Grid width"
                             decrementButtonClass="p-button-danger" incrementButtonClass="p-button-success" incrementButtonIcon="pi pi-plus" (ngModelChange)="updateButtonsGrid()"
                             decrementButtonIcon="pi pi-minus" [min]="gridSizeMin.width" [max]="screenLayout?.grid!.max.width" styleClass="grid-size"></p-inputNumber>
              <p-inputNumber [(ngModel)]="currentPage.grid.height" [showButtons]="true" buttonLayout="horizontal" spinnerMode="horizontal" [step]="1" pTooltip="Grid height"
                             decrementButtonClass="p-button-danger" incrementButtonClass="p-button-success" incrementButtonIcon="pi pi-plus" (ngModelChange)="updateButtonsGrid()"
                             decrementButtonIcon="pi pi-minus" [min]="gridSizeMin.height" [max]="screenLayout?.grid!.max.height" styleClass="grid-size"></p-inputNumber>
            </div>
          </div>
          </div>
      </div>
  <div class="grid-container" *ngIf="toggleGrid"
       [style]="{'grid-template-columns': 'auto '.repeat(currentPage.grid.width), 'width': gridPixelWidth+'px', 'height': gridPixelHeight+'px'}">
    <grid-button [editable]="editMode" *ngFor="let item of gridCommands; let index=index" [source]="gridItemSource" [item]="item" [grid]="currentPage.grid" [style]="getGridItemSize(item)"
                 (sourceSelected)="gridSourceSelected($event)" (destinationSelected)="gridDestinationSelected($event)" [gridCommands]="gridCommands"
                 (itemClicked)="gridItemClicked($event)" [selectionMode]="selectionMode">
      <ng-container *ngIf="Helper.isStandardIcon(item?.icon)">
        <span [class]="Helper.getIconClass(item?.icon)"></span>
      </ng-container>
      <ng-container *ngIf="Helper.isCustomIcon(item?.icon)">
        <img [src]="Helper.getIconURL(remote!, item?.icon)" [alt]="item?.icon" width="70" height="70">
      </ng-container>

      <ng-container *ngIf="item?.text">
        <span><b>{{item?.text}}</b></span><br>
      </ng-container>
      <ng-container *ngIf="item && item.command != null">
        <p-chip [label]="getEntityName((item.command | as : Command)?.entity_id!)"
                [style]="getStyle(getEntityName((item.command | as : Command)?.entity_id!))"></p-chip><br><br>
        <p-chip [label]="getCommandName(item.command)" styleClass="chip-command"
                [style]="getStyle((item.command | as : Command)?.cmd_id!)"></p-chip>
      </ng-container>
      <span *ngIf="item?.media_player_id" style="text-align: center">
        <p-chip [label]="getEntityName(item?.media_player_id!)"
                [style]="getStyle(getEntityName(item?.media_player_id!))"></p-chip>
        <div style="position: relative; width: 100%;height: 100%">
          <img src="/assets/icons/media_player.svg" alt="Media player" class="media_player_icon">
        </div>
      </span>
      <ng-container *ngFor="let param of getParams(item?.command)">
        <ng-container *ngIf="getParam(item?.command, param)">
          {{Helper.getEntityName(getParam(item?.command, param))}} :
          {{getParamValue(item?.command, param)}}
        </ng-container>
      </ng-container>
    </grid-button>
  </div>
    </div>
  </ng-container>
  <ng-container *ngIf="editMode">
    <app-activity-page-list [remote]="remote" [activity]="activity" [editable]="editMode" (onReorder)="onReorderPages($event)" (onSelectPage)="selectPage($event)"/>
  </ng-container>
</div>
<app-button-editor [activity]="activity" [remote]="remote" [button]="selectedButton" (buttonChanged)="buttonChanged($event)"></app-button-editor>
  <ng-container *ngIf="activity"><br><p-button label="Show data" (onClick)="showDump = true"></p-button>&nbsp;
    <p-button *ngIf="showDump"  label="Copy data to clipboard" (onClick)="copyToClipboard(activity)"></p-button>
    <ngx-json-viewer *ngIf="showDump" [json]="activity"></ngx-json-viewer>
  </ng-container>
<p-confirmDialog key="activityViewerDialog" rejectButtonStyleClass="p-button-outlined" />
